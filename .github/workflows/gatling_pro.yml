name: Gatling Advanced Benchmark

on:
  workflow_dispatch:

jobs:
  gatling-advanced-test:
    runs-on: ubuntu-latest

    steps:
      # -------------------------------------------------------
      # 1. Checkout repo
      # -------------------------------------------------------
      - name: ðŸ“¥ Checkout repo
        uses: actions/checkout@v4

      # -------------------------------------------------------
      # 2. Install monitoring tools
      # -------------------------------------------------------
      - name: ðŸ“¦ Install monitoring tools (sysstat, gnuplot, jq, procps)
        run: |
          sudo apt-get update
          sudo apt-get install -y sysstat gnuplot jq procps

      # -------------------------------------------------------
      # 3. Download Gatling Standalone bundle
      # -------------------------------------------------------
      - name: ðŸ“¥ Download Gatling Standalone 3.10.5
        run: |
          wget https://repo1.maven.org/maven2/io/gatling/highcharts/gatling-charts-highcharts-bundle/3.10.5/gatling-charts-highcharts-bundle-3.10.5-bundle.zip -O gatling.zip
          unzip gatling.zip
          mv gatling-charts-highcharts-bundle-3.10.5 gatling

      # -------------------------------------------------------
      # 4. Copy your Simulation into Gatling user-files
      #    âš ï¸ Si tu carpeta es 'gatling/' en minÃºscula, cambia la ruta de origen.
      # -------------------------------------------------------
      - name: ðŸ“„ Copy LoadTestSimulation into Gatling
        run: |
          mkdir -p gatling/user-files/simulations
          cp Gatling/simulations/LoadTestSimulation.scala gatling/user-files/simulations/

      # -------------------------------------------------------
      # 5. Start CPU/RAM/Threads monitors
      # -------------------------------------------------------
      - name: ðŸ§ª Start monitors
        run: |
          # CPU, RAM, IO each second
          pidstat -durh 1 > pidstat.log &
          echo $! > pidstat_pid.txt

          # top snapshots
          (while true; do
             top -b -n1 | head -30 >> top.log
             echo "---" >> top.log
             sleep 3
           done) &
          echo $! > top_pid.txt

          # threads of Gatling process
          (while true; do
             PID=$(pgrep -f "gatling" || true)
             if [ ! -z "$PID" ]; then
               ps -T -p "$PID" >> threads_raw.log 2>/dev/null || true
             fi
             sleep 1
           done) &
          echo $! > threads_pid.txt

      # -------------------------------------------------------
      # 6. Run Gatling Simulation
      # -------------------------------------------------------
      - name: ðŸš€ Run Gatling Load Test
        run: |
          echo "Running Gatling benchmark..."
          mkdir -p results

          GATLING_OUT=$(mktemp)

          # GATLING_HOME apunta a la carpeta bundle
          export GATLING_HOME="$PWD/gatling"

          /usr/bin/time -v \
            "$GATLING_HOME/bin/gatling.sh" \
              -s simulations.LoadTestSimulation \
              -rf results \
            2> time_metrics.txt | tee "$GATLING_OUT"

          mv "$GATLING_OUT" results/gatling_stdout.txt
          echo "âœ” Gatling test finished"

      # -------------------------------------------------------
      # 7. Stop monitors
      # -------------------------------------------------------
      - name: ðŸ›‘ Stop monitors
        if: always()
        run: |
          for f in pidstat_pid.txt top_pid.txt threads_pid.txt; do
            if [ -f "$f" ]; then
              PID=$(cat "$f")
              if kill -0 "$PID" 2>/dev/null; then
                kill "$PID" || true
              fi
            fi
          done

      # -------------------------------------------------------
      # 8. Extract p95, p99, RPS from Gatling simulation.log
      # -------------------------------------------------------
      - name: ðŸ“‰ Extract Gatling metrics (p95, p99, RPS)
        run: |
          # Busca el simulation.log generado por Gatling
          SIM_LOG=$(find results -name "simulation.log" | head -1 || true)

          if [ -z "$SIM_LOG" ]; then
            echo "âŒ simulation.log not found, skipping metrics extraction"
            exit 0
          fi

          echo "Using simulation log: $SIM_LOG"

          # Gatling simulation.log tiene lÃ­neas 'REQUEST' con tiempos
          # Asumimos formato CSV-like donde una columna es la duraciÃ³n.
          # Ajustable despuÃ©s si quieres mayor precisiÃ³n.

          # p95 / p99 (duraciones)
          awk -F',' '/REQUEST/ {print $9}' "$SIM_LOG" | sort -n | awk '
            NR==1 {next}      # saltar posible header
            { vals[++n]=$1 }
            END {
              if (n > 0) {
                p95_i = int(0.95*n); if (p95_i < 1) p95_i = 1
                p99_i = int(0.99*n); if (p99_i < 1) p99_i = n
                print vals[p95_i] > "p95.txt"
                print vals[p99_i] > "p99.txt"
              } else {
                print 0 > "p95.txt"
                print 0 > "p99.txt"
              }
            }
          '

          # RPS aproximado: total REQUEST / duraciÃ³n total (segundos)
          awk -F',' '/REQUEST/ {
            count++
            if (min_start == 0 || $6 < min_start) min_start = $6
            if ($7 > max_end) max_end = $7
          }
          END {
            dur_ms = max_end - min_start
            if (dur_ms <= 0) {
              print 0 > "rps.txt"
            } else {
              dur_s = dur_ms / 1000.0
              rps = count / dur_s
              print rps > "rps.txt"
            }
          }' "$SIM_LOG"

      # -------------------------------------------------------
      # 9. Upload ALL artifacts
      # -------------------------------------------------------
      - name: ðŸ“‚ Upload Gatling Benchmark Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gatling-advanced-results
          path: |
            pidstat.log
            top.log
            threads_raw.log
            results/
            p95.txt
            p99.txt
            rps.txt
            time_metrics.txt
