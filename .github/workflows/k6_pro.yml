name: k6 Advanced Benchmark

on:
  workflow_dispatch:

jobs:
  k6-advanced-test:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout repo
        uses: actions/checkout@v4

      - name: ðŸ’¾ Install k6 (tar.gz, sin apt-key)
        run: |
          set -e
          K6_VERSION=v0.52.0

          echo "â¬‡ï¸ Downloading k6 ${K6_VERSION}..."
          curl -L "https://github.com/grafana/k6/releases/download/${K6_VERSION}/k6-${K6_VERSION}-linux-amd64.tar.gz" -o k6.tar.gz

          echo "ðŸ“¦ Unpacking..."
          tar -xzf k6.tar.gz

          echo "ðŸšš Moving k6 to /usr/local/bin..."
          sudo mv "k6-${K6_VERSION}-linux-amd64/k6" /usr/local/bin/k6
          sudo chmod +x /usr/local/bin/k6

          echo "âœ… k6 installed:"
          k6 version

      - name: ðŸ“¦ Install system monitoring tools
        run: |
          sudo apt-get update
          sudo apt-get install -y sysstat

      - name: ðŸ§ª Start system metric monitors
        run: |
          # CPU / RAM por proceso
          pidstat -durh 1 > pidstat.log &
          echo $! > pidstat_pid.txt

          # Snapshot de top cada 2s
          (while true; do top -b -n1 | head -40 >> top.log; sleep 2; done) &
          echo $! > top_pid.txt

      - name: ðŸš€ Run k6 test (summary + CSV)
        run: |
          mkdir -p results

          echo "â–¶ Running k6 with summary export and CSV metrics..."
          k6 run \
            --summary-export=results/summary.json \
            --out csv=results/metrics.csv \
            k6/scripts/test.js \
            2>&1 | tee k6.log

      - name: ðŸ›‘ Stop system metric monitors
        if: always()
        run: |
          kill "$(cat pidstat_pid.txt)" || true
          kill "$(cat top_pid.txt)"     || true

      - name: ðŸ“Š Extract k6 metrics (alineado con Pulse)
        run: |
          mkdir -p k6_metrics

          # Latencias crudas (http_req_duration) desde metrics.csv
          # Formato CSV por defecto: time,metric,value,....
          awk -F',' 'NR>1 && $3=="http_req_duration" {print $1","$5}' results/metrics.csv > k6_metrics/http_req_duration_timeline.csv || true

          # Timeline de VUs
          awk -F',' 'NR>1 && $3=="vus" {print $1","$5}' results/metrics.csv > k6_metrics/vus_timeline.csv || true

          # http_reqs (para aproximar RPS)
          awk -F',' 'NR>1 && $3=="http_reqs" {print $1","$5}' results/metrics.csv > k6_metrics/http_reqs_timeline.csv || true

          # Copiamos CPU/RAM crudos
          cp pidstat.log k6_metrics/pidstat.log
          cp top.log      k6_metrics/top.log

      - name: ðŸ“‚ Upload k6 Advanced Benchmark Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: k6-advanced-results
          path: |
            k6.log
            results/
            k6_metrics/
            pidstat.log
            top.log
