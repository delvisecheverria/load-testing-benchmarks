name: Pulse Advanced Benchmark

on:
  workflow_dispatch:

jobs:
  pulse-advanced-test:
    runs-on: ubuntu-latest

    steps:
      # -------------------------------------------------------
      # 1. Checkout repo
      # -------------------------------------------------------
      - name: ðŸ“¥ Checkout repo
        uses: actions/checkout@v4


      # -------------------------------------------------------
      # 2. Install Go and build Pulse binary
      # -------------------------------------------------------
      - name: ðŸ›  Install Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: âš™ï¸ Build Pulse
        run: |
          echo "Building Pulse..."
          go mod tidy
          go build -o pulse ./cmd/pulse
          ls -lh pulse


      # -------------------------------------------------------
      # 3. DEBUG â€” show repo tree
      # -------------------------------------------------------
      - name: ðŸ”Ž DEBUG â€” Show repository structure
        run: |
          echo "ðŸ“ Repository tree:"
          find . -maxdepth 5 -type f | sort


      # -------------------------------------------------------
      # 4. Install monitoring tools
      # -------------------------------------------------------
      - name: ðŸ“¦ Install system monitoring tools
        run: |
          sudo apt-get update
          sudo apt-get install -y sysstat gnuplot jq procps


      # -------------------------------------------------------
      # 5. Start monitors (CPU / RAM / threads)
      # -------------------------------------------------------
      - name: ðŸ§ª Start monitors
        run: |
          # CPU y RAM por proceso cada 1s
          pidstat -durh 1 > pidstat.log &
          echo $! > pidstat_pid.txt

          # Snapshot del top cada 3s
          (while true; do
             top -b -n1 | head -30 >> top.log
             echo "---" >> top.log
             sleep 3
           done) &
          echo $! > top_pid.txt

          # Monitor de threads reales del proceso Pulse
          (while true; do
             PID=$(pgrep -f "./pulse run" || pgrep -f "pulse run" || true)
             if [ ! -z "$PID" ]; then
               ps -T -p "$PID" >> threads_raw.log 2>/dev/null || true
             fi
             sleep 1
           done) &
          echo $! > threads_pid.txt


      # -------------------------------------------------------
      # 6. Run Pulse test
      # -------------------------------------------------------
      - name: ðŸš€ Run Pulse Load Test
        run: |
          echo "Running Pulse load test..."
          mkdir -p results

          PULSE_OUT=$(mktemp)

          /usr/bin/time -v \
            ./pulse run Pulse/scripts/pulse.yaml \
            --output=results/pulse_results.json \
            2> time_metrics.txt | tee "$PULSE_OUT"

          mv "$PULSE_OUT" results/pulse_stdout.txt
          echo "âœ” Pulse test finished"


      # -------------------------------------------------------
      # 7. Stop monitors
      # -------------------------------------------------------
      - name: ðŸ›‘ Stop monitors
        if: always()
        run: |
          for f in pidstat_pid.txt top_pid.txt threads_pid.txt; do
            if [ -f "$f" ]; then
