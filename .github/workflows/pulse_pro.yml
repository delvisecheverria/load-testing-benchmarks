
name:  Pulse Advanced Benchmark

on:
  workflow_dispatch:

jobs:
  pulse-advanced-test:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout repo
        uses: actions/checkout@v4

      - name: ðŸ›  Download Pulse binary (Linux)
        run: |
          mkdir -p pulse_bin
          wget -O pulse_bin/worker \
            https://github.com/delvisecheverria/pcr/releases/latest/download/worker-linux
          chmod +x pulse_bin/worker

      - name: ðŸ“¦ Install system monitoring tools
        run: |
          sudo apt-get update
          sudo apt-get install -y sysstat gnuplot

      - name: ðŸ§ª Start system metric monitors
        run: |
          # CPU, RAM, IO every second
          pidstat -durh 1 > pidstat.log &
          echo $! > pidstat_pid.txt

          # top snapshots
          (while true; do top -b -n1 | head -30 >> top.log; sleep 3; done) &
          echo $! > top_pid.txt

          # goroutine counter â€“ external process
          (while true; do ps -eo pid,cmd | grep worker | grep -v grep; sleep 1; done) > goroutines_raw.log &
          echo $! > gor_pid.txt

      - name: ðŸš€ Run Pulse Advanced Test
        run: |
          echo "Running Pulse advanced load test..."
          /usr/bin/time -v \
            ./pulse_bin/worker \
              -yaml "Pulse/scripts/pulse.yaml" \
            2> time_metrics.txt

      - name: ðŸ›‘ Stop background monitors
        if: always()
        run: |
          kill $(cat pidstat_pid.txt) || true
          kill $(cat top_pid.txt) || true
          kill $(cat gor_pid.txt) || true

      - name: ðŸ“Š Process goroutine snapshots
        run: |
          # Extract PID of worker
          WORKER_PID=$(pgrep -f "pulse_bin/worker" || echo "0")
          if [ "$WORKER_PID" != "0" ]; then
            # Filter only repeated PID lines
            grep "$WORKER_PID" goroutines_raw.log | awk '{print $1}' > goroutines.log
          fi

      - name: ðŸ—‚ Upload Full Benchmark Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pulse-advanced-results
          path: |
            pidstat.log
            top.log
            goroutines.log
            goroutines_raw.log
            time_metrics.txt
            Pulse/scripts/pulse.yaml
