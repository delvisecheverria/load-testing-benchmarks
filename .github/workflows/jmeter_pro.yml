name: JMeter Advanced Benchmark

on:
  workflow_dispatch:

jobs:
  jmeter-advanced-test:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout repo
        uses: actions/checkout@v4

      - name: ðŸ’¾ Install JMeter
        run: |
          wget https://archive.apache.org/dist/jmeter/binaries/apache-jmeter-5.6.2.tgz
          tar -xzf apache-jmeter-5.6.2.tgz
          export JMETER_HOME="$PWD/apache-jmeter-5.6.2"
          echo "$JMETER_HOME/bin" >> $GITHUB_PATH

      - name: ðŸ“¦ Install monitoring tools
        run: |
          sudo apt-get update
          sudo apt-get install -y sysstat gnuplot python3

      - name: ðŸ§ª Start system metric monitors (CPU, MEM, Threads, System Load)
        run: |
          # CPU + Memory timeline
          pidstat -durh 1 > pidstat.log &
          echo $! > pidstat_pid.txt

          # System-wide metrics
          (while true; do top -b -n1 | head -40 >> top.log; sleep 2; done) &
          echo $! > top_pid.txt

          # Thread timeline (Java worker threads)
          (while true; do 
              JMETER_PID=$(pgrep -f "ApacheJMeter" || true)
              if [ -n "$JMETER_PID" ]; then 
                ps -T -p "$JMETER_PID" >> threads_raw.log 2>/dev/null
              fi
              sleep 1
          done) &
          echo $! > threads_pid.txt

      - name: ðŸš€ Run JMeter Advanced Load Test
        run: |
          echo "Running JMeter advanced test..."
          mkdir -p results

          # /usr/bin/time -v captures:
          # - Max resident set (MEM)
          # - CPU %
          # - Context switches
          # - Page faults
          # - Elapsed time
          /usr/bin/time -v \
            jmeter \
              -n \
              -t Jmeter/scripts/jmeter.jmx \
              -l results/jmeter_results.jtl \
              -e -o results/dashboard \
            2> time_metrics.txt

      - name: ðŸ›‘ Stop monitors
        if: always()
        run: |
          kill $(cat pidstat_pid.txt) || true
          kill $(cat top_pid.txt) || true
          kill $(cat threads_pid.txt) || true

      - name: ðŸ“Š Extract thread count timeline
        run: |
          # Extract only thread IDs (count per sample)
          grep -v "PID" threads_raw.log | awk '{print $1}' > threads.log || true

      - name: ðŸ“ˆ Extract latency distribution (p95, p99)
        run: |
          # Extract elapsed times from JTL (column 2)
          awk -F',' 'NR>1 {print $2}' results/jmeter_results.jtl > latencies.txt

          awk '{a[NR]=$1} END {
            asort(a)
            p95=a[int(NR*0.95)]
            p99=a[int(NR*0.99)]
            print "p95_ms="p95 > "latency_summary.txt"
            print "p99_ms="p99 >> "latency_summary.txt"
          }' latencies.txt

      - name: ðŸ“¦ Create jmeter_summary.json
        run: |
          cat > build_jmeter_summary.py << 'PYCODE'
          import csv, json

          rows = list(csv.DictReader(open("results/jmeter_results.jtl")))
          lat = [int(r["elapsed"]) for r in rows]
          lat_sorted = sorted(lat)

          out = {
              "samples": len(lat),
              "avg_ms": sum(lat) / len(lat) if lat else 0,
              "p95_ms": lat_sorted[int(len(lat_sorted) * 0.95)] if lat_sorted else 0,
              "p99_ms": lat_sorted[int(len(lat_sorted) * 0.99)] if lat_sorted else 0,
          }

          with open("jmeter_summary.json", "w") as f:
              json.dump(out, f, indent=2)
          PYCODE

          python3 build_jmeter_summary.py

      - name: ðŸ“ˆ Extract RPS (Requests Per Second)
        run: |
          awk -F',' 'NR>1 {print int($1/1000)"s"}' results/jmeter_results.jtl | \
            uniq -c | awk '{print $2","$1}' > rps_timeline.csv || true

      - name: ðŸ“‚ Upload Advanced Benchmark Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: jmeter-advanced-results
          path: |
            pidstat.log
            top.log
            threads.log
            threads_raw.log
            time_metrics.txt
            results/
            latency_summary.txt
            latencies.txt
            rps_timeline.csv
            jmeter_summary.json
            Jmeter/scripts/jmeter.jmx
