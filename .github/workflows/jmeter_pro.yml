name: ðŸ”´ JMeter Advanced Benchmark

on:
  workflow_dispatch:

jobs:
  jmeter-advanced-test:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout repo
        uses: actions/checkout@v4

      - name: ðŸ’¾ Install JMeter
        run: |
          wget https://archive.apache.org/dist/jmeter/binaries/apache-jmeter-5.6.2.tgz
          tar -xzf apache-jmeter-5.6.2.tgz
          export JMETER_HOME="$PWD/apache-jmeter-5.6.2"
          echo "$JMETER_HOME/bin" >> $GITHUB_PATH

      - name: ðŸ“¦ Install system monitoring tools
        run: |
          sudo apt-get update
          sudo apt-get install -y sysstat gnuplot

      - name: ðŸ§ª Start system metric monitors
        run: |
          pidstat -durh 1 > pidstat.log &
          echo $! > pidstat_pid.txt

          (while true; do top -b -n1 | head -30 >> top.log; sleep 3; done) &
          echo $! > top_pid.txt

          (while true; do ps -T -p "$(pgrep -f jmeter)" >> threads_raw.log 2>/dev/null; sleep 1; done) &
          echo $! > threads_pid.txt

      - name: ðŸš€ Run JMeter Advanced Load Test
        run: |
          echo "Running JMeter advanced test..."
          mkdir -p results

          /usr/bin/time -v \
            jmeter \
              -n \
              -t load-testing-benchmarks/Jmeter/scripts/jmeter.jmx \
              -l results/jmeter_results.jtl \
              -e -o results/dashboard \
            2> time_metrics.txt

      - name: ðŸ›‘ Stop monitors
        if: always()
        run: |
          kill $(cat pidstat_pid.txt) || true
          kill $(cat top_pid.txt) || true
          kill $(cat threads_pid.txt) || true

      - name: ðŸ“Š Extract thread count timeline
        run: |
          grep "java" threads_raw.log | awk '{print $1}' > threads.log || true

      - name: ðŸ“ˆ Extract p95 & p99
        run: |
          awk -F',' 'NR>1 {print $2}' results/jmeter_results.jtl > latencies.txt
          awk '{a[NR]=$1} END {
            asort(a)
            p95=a[int(NR*0.95)]
            p99=a[int(NR*0.99)]
            print "p95_ms="p95 > "latency_summary.txt"
            print "p99_ms="p99 >> "latency_summary.txt"
          }' latencies.txt

      - name: ðŸ“‚ Upload Advanced Benchmark Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: jmeter-advanced-results
          path: |
            pidstat.log
            top.log
            threads.log
            threads_raw.log
            time_metrics.txt
            results/
            load-testing-benchmarks/Jmeter/scripts/jmeter.jmx

